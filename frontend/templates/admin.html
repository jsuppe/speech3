{% extends "base.html" %}
{% block title %}Dashboard â€” SpeakFit{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-white">Dashboard</h1>
        <p class="text-sm text-gray-400 mt-1">Platform analytics and user statistics</p>
    </div>

    <!-- Key Metrics: DAU, MAU, MoM Growth -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="metric-card bg-gradient-to-br from-blue-900/40 to-blue-800/20 rounded-xl border border-blue-700/50 p-5">
            <div class="flex items-center justify-between">
                <div class="text-3xl font-bold text-blue-400">{{ stats.dau }}</div>
                {% if stats.dau_yesterday > 0 %}
                    {% set dau_change = ((stats.dau - stats.dau_yesterday) / stats.dau_yesterday * 100) %}
                    <span class="text-sm px-2 py-1 rounded-full {% if dau_change >= 0 %}bg-green-900/50 text-green-400{% else %}bg-red-900/50 text-red-400{% endif %}">
                        {% if dau_change >= 0 %}+{% endif %}{{ "%.0f"|format(dau_change) }}%
                    </span>
                {% endif %}
            </div>
            <div class="text-sm text-gray-400 mt-1">ðŸ“… Daily Active Users</div>
            <div class="text-xs text-gray-500 mt-1">vs {{ stats.dau_yesterday }} yesterday</div>
        </div>
        <div class="metric-card bg-gradient-to-br from-indigo-900/40 to-indigo-800/20 rounded-xl border border-indigo-700/50 p-5">
            <div class="text-3xl font-bold text-indigo-400">{{ stats.mau }}</div>
            <div class="text-sm text-gray-400 mt-1">ðŸ“† Monthly Active Users</div>
            <div class="text-xs text-gray-500 mt-1">Last 30 days</div>
        </div>
        <div class="metric-card bg-gradient-to-br from-purple-900/40 to-purple-800/20 rounded-xl border border-purple-700/50 p-5">
            <div class="flex items-center">
                <div class="text-3xl font-bold {% if stats.mom_growth >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    {% if stats.mom_growth >= 0 %}+{% endif %}{{ "%.1f"|format(stats.mom_growth) }}%
                </div>
            </div>
            <div class="text-sm text-gray-400 mt-1">ðŸ“ˆ Month-over-Month</div>
            <div class="text-xs text-gray-500 mt-1">{{ stats.mau_prev_month }} â†’ {{ stats.mau }}</div>
        </div>
        <div class="metric-card bg-gradient-to-br from-green-900/40 to-green-800/20 rounded-xl border border-green-700/50 p-5">
            <div class="text-3xl font-bold text-green-400">{{ stats.paid_users }}</div>
            <div class="text-sm text-gray-400 mt-1">ðŸ’° Paid Users</div>
            <div class="text-xs text-gray-500 mt-1">
                {% for tier, count in stats.tier_stats.items() if tier not in ['free', 'none', None] %}
                    {{ tier }}: {{ count }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Subscription Growth -->
    <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.paid_today }}</div>
            <div class="text-sm text-gray-400 mt-1">New Paid Today</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.paid_week }}</div>
            <div class="text-sm text-gray-400 mt-1">New Paid This Week</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.paid_month }}</div>
            <div class="text-sm text-gray-400 mt-1">New Paid This Month</div>
        </div>
    </div>

    <!-- Secondary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.total_users }}</div>
            <div class="text-sm text-gray-400 mt-1">Total Users</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.total_recordings }}</div>
            <div class="text-sm text-gray-400 mt-1">Total Recordings</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-green-400">{{ stats.active_7d }}</div>
            <div class="text-sm text-gray-400 mt-1">Active (7 days)</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-amber-400">{{ "%.1f"|format(stats.storage_mb) }} MB</div>
            <div class="text-sm text-gray-400 mt-1">Storage Used</div>
        </div>
    </div>

    <!-- Activity Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.recordings_today }}</div>
            <div class="text-sm text-gray-400 mt-1">Recordings Today</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.recordings_week }}</div>
            <div class="text-sm text-gray-400 mt-1">This Week</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ "%.1f"|format(stats.avg_score) if stats.avg_score else 'N/A' }}</div>
            <div class="text-sm text-gray-400 mt-1">Avg Score</div>
        </div>
        <div class="metric-card bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="text-2xl font-bold text-white">{{ stats.survey_total }}</div>
            <div class="text-sm text-gray-400 mt-1">Survey Responses</div>
        </div>
    </div>

    <!-- DAU Trend Chart -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4">ðŸ“… Daily Active Users (14 days)</h2>
        <canvas id="dauChart" height="120"></canvas>
    </div>

    <!-- Charts Row -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Recordings Over Time -->
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Recordings Over Time (30 days)</h2>
            <canvas id="recordingsChart" height="200"></canvas>
        </div>

        <!-- Users Over Time -->
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">User Signups (30 days)</h2>
            <canvas id="usersChart" height="200"></canvas>
        </div>
    </div>

    <!-- More Charts -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Score Distribution -->
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Score Distribution</h2>
            <canvas id="scoreChart" height="200"></canvas>
        </div>

        <!-- Recordings by Category -->
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Recordings by Category</h2>
            <canvas id="categoryChart" height="200"></canvas>
        </div>
    </div>

    <!-- Survey Insights Section -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-white">ðŸ“‹ Onboarding Survey Insights</h2>
            <div class="text-sm text-gray-400">
                {{ stats.survey_total }} responses ({{ "%.0f"|format(stats.survey_completion_rate) }}% completion)
            </div>
        </div>
        
        <!-- Survey Charts Grid -->
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Primary Goals</h3>
                <canvas id="surveyGoalsChart" height="150"></canvas>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Skill Levels</h3>
                <canvas id="surveySkillChart" height="150"></canvas>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Usage Context</h3>
                <canvas id="surveyContextChart" height="150"></canvas>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Focus Areas</h3>
                <canvas id="surveyFocusChart" height="150"></canvas>
            </div>
        </div>
        
        <!-- Recent Surveys Table -->
        {% if recent_surveys %}
        <h3 class="text-sm font-medium text-gray-400 mb-3">Recent Survey Submissions</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-700">
                        <th class="text-left py-2 pr-4 font-medium">User</th>
                        <th class="text-left py-2 pr-4 font-medium">Primary Goal</th>
                        <th class="text-left py-2 pr-4 font-medium">Skill Level</th>
                        <th class="text-left py-2 pr-4 font-medium">Context</th>
                        <th class="text-left py-2 pr-4 font-medium">Focus Areas</th>
                        <th class="text-right py-2 font-medium">Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in recent_surveys %}
                    <tr class="border-b border-gray-800/50 hover:bg-gray-800/30">
                        <td class="py-2 pr-4 text-white">{{ s.name or s.email }}</td>
                        <td class="py-2 pr-4">
                            <span class="px-2 py-1 bg-indigo-500/20 text-indigo-300 rounded text-xs">{{ s.primary_goal }}</span>
                        </td>
                        <td class="py-2 pr-4">
                            <span class="px-2 py-1 bg-emerald-500/20 text-emerald-300 rounded text-xs">{{ s.skill_level }}</span>
                        </td>
                        <td class="py-2 pr-4 text-gray-400">{{ s.context | replace('_', ' ') }}</td>
                        <td class="py-2 pr-4 text-gray-400 text-xs">{{ s.focus_areas | replace('[', '') | replace(']', '') | replace('"', '') }}</td>
                        <td class="py-2 text-right text-gray-500">{{ s.completed_at[:10] if s.completed_at else 'â€”' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 text-sm">No survey responses yet.</p>
        {% endif %}
    </div>

    <!-- Top Users Table -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white">Top Users by Recordings</h2>
            <a href="#all-users" class="text-sm text-indigo-400 hover:text-indigo-300">View all â†“</a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-800">
                        <th class="text-left py-2 pr-4 font-medium">User</th>
                        <th class="text-left py-2 pr-4 font-medium">Email</th>
                        <th class="text-right py-2 pr-4 font-medium">Recordings</th>
                        <th class="text-right py-2 pr-4 font-medium">Avg Score</th>
                        <th class="text-right py-2 font-medium">Joined</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in top_users %}
                    <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 cursor-pointer" onclick="window.location='/admin/users/{{ u.id }}'">
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-3">
                                {% if u.picture %}
                                <img src="{{ u.picture }}" alt="" class="w-8 h-8 rounded-full">
                                {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-xs font-bold">
                                    {{ u.name[0] if u.name else '?' }}
                                </div>
                                {% endif %}
                                <span class="text-white font-medium">{{ u.name or 'Unknown' }}</span>
                            </div>
                        </td>
                        <td class="py-3 pr-4 text-gray-400">{{ u.email }}</td>
                        <td class="py-3 pr-4 text-right text-white font-mono">{{ u.speech_count }}</td>
                        <td class="py-3 pr-4 text-right">
                            {% if u.avg_score %}
                            <span class="{% if u.avg_score >= 80 %}text-green-400{% elif u.avg_score >= 60 %}text-yellow-400{% else %}text-red-400{% endif %}">
                                {{ "%.1f"|format(u.avg_score) }}
                            </span>
                            {% else %}
                            <span class="text-gray-500">â€”</span>
                            {% endif %}
                        </td>
                        <td class="py-3 text-right text-gray-400">{{ u.created_at[:10] if u.created_at else 'â€”' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- All Users Section -->
    <div id="all-users" class="bg-gray-900 rounded-xl border border-gray-800 p-6 mb-8">
        <div class="flex items-center gap-3 mb-4">
            <h2 class="text-lg font-semibold text-white">All Users</h2>
            <span class="bg-indigo-500/20 text-indigo-400 text-xs font-medium px-2 py-0.5 rounded">{{ all_users|length }} total</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-800">
                        <th class="text-left py-2 pr-4 font-medium">User</th>
                        <th class="text-left py-2 pr-4 font-medium">Email</th>
                        <th class="text-left py-2 pr-4 font-medium">Provider</th>
                        <th class="text-right py-2 pr-4 font-medium">Recordings</th>
                        <th class="text-right py-2 pr-4 font-medium">Joined</th>
                        <th class="text-right py-2 font-medium">Last Login</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in all_users %}
                    <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 cursor-pointer" onclick="window.location='/admin/users/{{ u.id }}'">
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-3">
                                {% if u.picture %}
                                <img src="{{ u.picture }}" alt="" class="w-8 h-8 rounded-full">
                                {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-xs font-bold">
                                    {{ u.name[0] if u.name else '?' }}
                                </div>
                                {% endif %}
                                <span class="text-white font-medium">{{ u.name or 'Unknown' }}</span>
                            </div>
                        </td>
                        <td class="py-3 pr-4 text-gray-400">{{ u.email }}</td>
                        <td class="py-3 pr-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                                {% if u.provider == 'google' %}bg-blue-900/50 text-blue-300{% else %}bg-gray-700 text-gray-400{% endif %}">
                                {{ u.provider | capitalize if u.provider else 'Unknown' }}
                            </span>
                        </td>
                        <td class="py-3 pr-4 text-right text-white font-mono">{{ u.speech_count or 0 }}</td>
                        <td class="py-3 pr-4 text-right text-gray-400">{{ u.created_at[:10] if u.created_at else 'â€”' }}</td>
                        <td class="py-3 text-right text-gray-400">{{ u.last_login[:10] if u.last_login else 'â€”' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
        <h2 class="text-lg font-semibold text-white mb-4">Recent Recordings</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-800">
                        <th class="text-left py-2 pr-4 font-medium">Title</th>
                        <th class="text-left py-2 pr-4 font-medium">User</th>
                        <th class="text-right py-2 pr-4 font-medium">Score</th>
                        <th class="text-right py-2 font-medium">When</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in recent_recordings %}
                    <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 cursor-pointer" onclick="window.location='/recordings/{{ r.id }}'">
                        <td class="py-3 pr-4 text-white">{{ r.title[:50] }}{% if r.title|length > 50 %}...{% endif %}</td>
                        <td class="py-3 pr-4 text-gray-400">{{ r.user_name or 'Unknown' }}</td>
                        <td class="py-3 pr-4 text-right">
                            {% if r.score %}
                            <span class="{% if r.score >= 80 %}text-green-400{% elif r.score >= 60 %}text-yellow-400{% else %}text-red-400{% endif %}">
                                {{ "%.1f"|format(r.score) }}
                            </span>
                            {% else %}
                            <span class="text-gray-500">â€”</span>
                            {% endif %}
                        </td>
                        <td class="py-3 text-right text-gray-400">{{ r.created_at[:16].replace('T', ' ') if r.created_at else 'â€”' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chartData = {{ chart_data | safe }};

Chart.defaults.color = '#9ca3af';
Chart.defaults.borderColor = '#1f2937';

// DAU Trend
if (chartData.dau_trend && chartData.dau_trend.length > 0) {
    new Chart(document.getElementById('dauChart'), {
        type: 'line',
        data: {
            labels: chartData.dau_trend.map(d => d.date.slice(5)), // MM-DD format
            datasets: [{
                label: 'DAU',
                data: chartData.dau_trend.map(d => d.dau),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#3b82f6',
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
}

// Recordings over time
new Chart(document.getElementById('recordingsChart'), {
    type: 'line',
    data: {
        labels: chartData.recordings_by_day.map(d => d.date),
        datasets: [{
            label: 'Recordings',
            data: chartData.recordings_by_day.map(d => d.count),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.3,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
    }
});

// User signups over time
new Chart(document.getElementById('usersChart'), {
    type: 'line',
    data: {
        labels: chartData.users_by_day.map(d => d.date),
        datasets: [{
            label: 'New Users',
            data: chartData.users_by_day.map(d => d.count),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.3,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
    }
});

// Score distribution histogram
const scoreBins = ['0-20', '20-40', '40-60', '60-80', '80-100'];
new Chart(document.getElementById('scoreChart'), {
    type: 'bar',
    data: {
        labels: scoreBins,
        datasets: [{
            data: chartData.score_distribution,
            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
            borderRadius: 4,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true },
            x: { title: { display: true, text: 'Score Range' } }
        }
    }
});

// Category distribution
new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
        labels: chartData.categories.map(c => c.category || 'Uncategorized'),
        datasets: [{
            data: chartData.categories.map(c => c.count),
            backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#64748b'],
        }]
    },
    options: {
        plugins: {
            legend: { position: 'right' }
        }
    }
});

// Survey Charts
const surveyColors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

// Survey Goals
if (chartData.survey_goals && chartData.survey_goals.length > 0) {
    new Chart(document.getElementById('surveyGoalsChart'), {
        type: 'doughnut',
        data: {
            labels: chartData.survey_goals.map(g => g.goal.replace('_', ' ')),
            datasets: [{
                data: chartData.survey_goals.map(g => g.count),
                backgroundColor: surveyColors,
            }]
        },
        options: {
            plugins: { legend: { display: false } }
        }
    });
}

// Survey Skill Levels
if (chartData.survey_skill_levels && chartData.survey_skill_levels.length > 0) {
    new Chart(document.getElementById('surveySkillChart'), {
        type: 'doughnut',
        data: {
            labels: chartData.survey_skill_levels.map(s => s.level),
            datasets: [{
                data: chartData.survey_skill_levels.map(s => s.count),
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
            }]
        },
        options: {
            plugins: { legend: { display: false } }
        }
    });
}

// Survey Contexts
if (chartData.survey_contexts && chartData.survey_contexts.length > 0) {
    new Chart(document.getElementById('surveyContextChart'), {
        type: 'doughnut',
        data: {
            labels: chartData.survey_contexts.map(c => c.context.replace('_', ' ')),
            datasets: [{
                data: chartData.survey_contexts.map(c => c.count),
                backgroundColor: surveyColors,
            }]
        },
        options: {
            plugins: { legend: { display: false } }
        }
    });
}

// Survey Focus Areas (horizontal bar)
if (chartData.survey_focus_areas && chartData.survey_focus_areas.length > 0) {
    new Chart(document.getElementById('surveyFocusChart'), {
        type: 'bar',
        data: {
            labels: chartData.survey_focus_areas.slice(0, 6).map(a => a.area.replace('_', ' ')),
            datasets: [{
                data: chartData.survey_focus_areas.slice(0, 6).map(a => a.count),
                backgroundColor: '#6366f1',
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { grid: { display: false } }
            }
        }
    });
}
</script>
{% endblock %}
