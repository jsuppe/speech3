{% extends "base.html" %}
{% block title %}Upload — SpeakFit{% endblock %}

{% block content %}
<div class="fade-in max-w-3xl mx-auto">
    <h1 class="text-2xl font-bold text-white mb-2">Upload Audio</h1>
    <p class="text-sm text-gray-400 mb-8">Upload audio files for recording analysis. Supports MP3, WAV, OGG, FLAC, M4A, OPUS. Single or batch upload.</p>

    <!-- Tab Switcher -->
    <div class="flex gap-1 mb-6 bg-gray-900 rounded-lg p-1 w-fit">
        <button id="tabSingle" onclick="switchTab('single')" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white transition-colors">
            Single File
        </button>
        <button id="tabBatch" onclick="switchTab('batch')" class="px-4 py-2 text-sm font-medium rounded-md text-gray-400 hover:text-white transition-colors">
            Batch Upload
        </button>
    </div>

    <!-- ======= SINGLE FILE UPLOAD ======= -->
    <div id="singlePanel">
        <!-- Upload Zone -->
        <div id="dropZone" class="border-2 border-dashed border-gray-700 rounded-xl p-12 text-center hover:border-indigo-500 transition-colors cursor-pointer"
             onclick="document.getElementById('fileInput').click()">
            <div id="dropContent">
                <svg class="mx-auto h-12 w-12 text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="text-gray-300 font-medium">Drop audio file here or click to browse</p>
                <p class="text-sm text-gray-500 mt-1">Max 50 MB</p>
            </div>
            <input type="file" id="fileInput" accept=".mp3,.wav,.ogg,.flac,.m4a,.opus,.webm" class="hidden">
        </div>

        <!-- Options -->
        <div class="mt-6 grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">Preset</label>
                <select id="preset" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white focus:border-indigo-500 focus:outline-none">
                    <option value="full">Full Analysis</option>
                    <option value="quick">Quick</option>
                    <option value="clinical">Clinical</option>
                    <option value="coaching">Coaching</option>
                    <option value="text_only">Text Only</option>
                    <option value="audio_only">Audio Only</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Language</label>
                <select id="language" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white focus:border-indigo-500 focus:outline-none">
                    <option value="en">English</option>
                    <option value="">Auto-detect</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                </select>
            </div>
        </div>

        <!-- Single file progress -->
        <div id="progress" class="hidden mt-6">
            <div class="flex items-center justify-between mb-2">
                <span id="progressText" class="text-sm text-gray-300">Uploading...</span>
                <span id="progressPct" class="text-sm text-gray-400 font-mono">0%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div id="progressBar" class="h-2 rounded-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Result -->
        <div id="result" class="hidden mt-6"></div>

        <!-- Error -->
        <div id="error" class="hidden mt-6 bg-red-500/10 border border-red-500/30 rounded-xl p-4">
            <p id="errorText" class="text-sm text-red-300"></p>
        </div>
    </div>

    <!-- ======= BATCH UPLOAD ======= -->
    <div id="batchPanel" class="hidden">
        <!-- Multi-file Drop Zone -->
        <div id="batchDropZone" class="border-2 border-dashed border-gray-700 rounded-xl p-12 text-center hover:border-indigo-500 transition-colors cursor-pointer"
             onclick="document.getElementById('batchFileInput').click()">
            <svg class="mx-auto h-12 w-12 text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-gray-300 font-medium">Drop multiple audio files or click to browse</p>
            <p class="text-sm text-gray-500 mt-1">Max 20 files, 50 MB each</p>
            <input type="file" id="batchFileInput" accept=".mp3,.wav,.ogg,.flac,.m4a,.opus,.webm" multiple class="hidden">
        </div>

        <!-- Batch Options -->
        <div class="mt-6 grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">Preset (all files)</label>
                <select id="batchPreset" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white focus:border-indigo-500 focus:outline-none">
                    <option value="full">Full Analysis</option>
                    <option value="quick">Quick</option>
                    <option value="clinical">Clinical</option>
                    <option value="coaching">Coaching</option>
                    <option value="text_only">Text Only</option>
                    <option value="audio_only">Audio Only</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Language</label>
                <select id="batchLanguage" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white focus:border-indigo-500 focus:outline-none">
                    <option value="en">English</option>
                    <option value="">Auto-detect</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                </select>
            </div>
        </div>

        <!-- Selected Files List -->
        <div id="batchFileList" class="hidden mt-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-white">Selected Files</h3>
                <button onclick="startBatchUpload()" id="batchSubmitBtn"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium rounded-lg transition-colors">
                    Upload All
                </button>
            </div>
            <div id="batchFiles" class="space-y-2"></div>
        </div>

        <!-- Batch Progress -->
        <div id="batchProgress" class="hidden mt-6">
            <div class="flex items-center justify-between mb-2">
                <span id="batchProgressText" class="text-sm text-gray-300">Submitting batch...</span>
                <span id="batchProgressPct" class="text-sm text-gray-400 font-mono">0%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2 mb-4">
                <div id="batchProgressBar" class="h-2 rounded-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="batchJobList" class="space-y-2"></div>
        </div>

        <!-- Batch Error -->
        <div id="batchError" class="hidden mt-6 bg-red-500/10 border border-red-500/30 rounded-xl p-4">
            <p id="batchErrorText" class="text-sm text-red-300"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_KEY = 'sk-5b7fd66025ead6b8731ef73b2c970f26';

// ======= TAB SWITCHING =======
function switchTab(tab) {
    const singlePanel = document.getElementById('singlePanel');
    const batchPanel = document.getElementById('batchPanel');
    const tabSingle = document.getElementById('tabSingle');
    const tabBatch = document.getElementById('tabBatch');

    if (tab === 'single') {
        singlePanel.classList.remove('hidden');
        batchPanel.classList.add('hidden');
        tabSingle.classList.add('bg-indigo-600', 'text-white');
        tabSingle.classList.remove('text-gray-400');
        tabBatch.classList.remove('bg-indigo-600', 'text-white');
        tabBatch.classList.add('text-gray-400');
    } else {
        singlePanel.classList.add('hidden');
        batchPanel.classList.remove('hidden');
        tabBatch.classList.add('bg-indigo-600', 'text-white');
        tabBatch.classList.remove('text-gray-400');
        tabSingle.classList.remove('bg-indigo-600', 'text-white');
        tabSingle.classList.add('text-gray-400');
    }
}

// ======= SINGLE FILE UPLOAD =======
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const progressPct = document.getElementById('progressPct');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');

['dragenter', 'dragover'].forEach(e => {
    dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-500/5'); });
});
['dragleave', 'drop'].forEach(e => {
    dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('border-indigo-500', 'bg-indigo-500/5'); });
});
dropZone.addEventListener('drop', ev => { if (ev.dataTransfer.files.length) uploadFile(ev.dataTransfer.files[0]); });
fileInput.addEventListener('change', () => { if (fileInput.files.length) uploadFile(fileInput.files[0]); });

async function uploadFile(file) {
    errorDiv.classList.add('hidden');
    resultDiv.classList.add('hidden');
    progress.classList.remove('hidden');
    progressText.textContent = `Uploading ${file.name}...`;
    progressBar.style.width = '0%';
    progressPct.textContent = '0%';

    const preset = document.getElementById('preset').value;
    const language = document.getElementById('language').value;
    const formData = new FormData();
    formData.append('audio', file);

    const params = new URLSearchParams({ mode: 'async', preset });
    if (language) params.append('language', language);

    try {
        progressBar.style.width = '10%';
        progressPct.textContent = '10%';
        const submitRes = await fetch(`/v1/analyze?${params}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${API_KEY}` },
            body: formData,
        });

        if (!submitRes.ok) {
            const err = await submitRes.json();
            throw new Error(err.error?.message || `HTTP ${submitRes.status}`);
        }

        const job = await submitRes.json();
        progressText.textContent = 'Analyzing...';
        progressBar.style.width = '20%';
        progressPct.textContent = '20%';

        const stages = ['transcription', 'text_analysis', 'audio_analysis', 'advanced_audio', 'sentiment', 'rhetorical'];
        while (true) {
            await new Promise(r => setTimeout(r, 1500));
            const pollRes = await fetch(`/v1/jobs/${job.job_id}`, {
                headers: { 'Authorization': `Bearer ${API_KEY}` },
            });
            const status = await pollRes.json();

            if (status.status === 'complete') {
                const result = status.result;
                progressBar.style.width = '100%';
                progressPct.textContent = '100%';
                progressText.textContent = 'Complete!';

                const speechId = result.speech_id;
                resultDiv.innerHTML = `
                    <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">✓ Analysis Complete</h3>
                        <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                            <div><span class="text-gray-400">WPM:</span> <span class="text-white font-mono">${result.audio_analysis?.speaking_rate?.overall_wpm?.toFixed(0) || '—'}</span></div>
                            <div><span class="text-gray-400">Pitch:</span> <span class="text-white font-mono">${result.audio_analysis?.pitch?.mean_hz?.toFixed(0) || '—'} Hz</span></div>
                            <div><span class="text-gray-400">Quality:</span> <span class="text-white font-mono">${result.audio_quality?.confidence || '—'}</span></div>
                        </div>
                        ${speechId ? `<a href="/recordings/${speechId}" class="inline-block px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium rounded-lg transition-colors">View Full Analysis →</a>` : ''}
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                break;
            } else if (status.status === 'failed') {
                throw new Error(status.error || 'Analysis failed');
            } else {
                const stage = (status.progress || '').replace('processing:', '');
                const idx = stages.indexOf(stage);
                const pct = Math.min(90, 20 + (idx >= 0 ? (idx + 1) * 12 : 5));
                progressBar.style.width = pct + '%';
                progressPct.textContent = pct + '%';
                progressText.textContent = `Analyzing: ${stage || 'processing'}...`;
            }
        }
    } catch (err) {
        document.getElementById('errorText').textContent = err.message;
        errorDiv.classList.remove('hidden');
        progress.classList.add('hidden');
    }
}

// ======= BATCH UPLOAD =======
const batchDropZone = document.getElementById('batchDropZone');
const batchFileInput = document.getElementById('batchFileInput');
let selectedFiles = [];

['dragenter', 'dragover'].forEach(e => {
    batchDropZone.addEventListener(e, ev => { ev.preventDefault(); batchDropZone.classList.add('border-indigo-500', 'bg-indigo-500/5'); });
});
['dragleave', 'drop'].forEach(e => {
    batchDropZone.addEventListener(e, ev => { ev.preventDefault(); batchDropZone.classList.remove('border-indigo-500', 'bg-indigo-500/5'); });
});
batchDropZone.addEventListener('drop', ev => {
    if (ev.dataTransfer.files.length) {
        selectedFiles = Array.from(ev.dataTransfer.files).slice(0, 20);
        renderBatchFileList();
    }
});
batchFileInput.addEventListener('change', () => {
    if (batchFileInput.files.length) {
        selectedFiles = Array.from(batchFileInput.files).slice(0, 20);
        renderBatchFileList();
    }
});

function renderBatchFileList() {
    const container = document.getElementById('batchFiles');
    const panel = document.getElementById('batchFileList');
    panel.classList.remove('hidden');

    container.innerHTML = selectedFiles.map((f, i) => `
        <div class="flex items-center justify-between bg-gray-800/50 rounded-lg px-3 py-2">
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 font-mono w-6">${i + 1}.</span>
                <span class="text-sm text-white">${f.name}</span>
            </div>
            <span class="text-xs text-gray-500">${(f.size / 1024 / 1024).toFixed(1)} MB</span>
        </div>
    `).join('');
}

async function startBatchUpload() {
    if (!selectedFiles.length) return;

    const batchError = document.getElementById('batchError');
    batchError.classList.add('hidden');
    document.getElementById('batchSubmitBtn').disabled = true;
    document.getElementById('batchSubmitBtn').classList.add('opacity-50');

    const batchProgress = document.getElementById('batchProgress');
    const batchProgressBar = document.getElementById('batchProgressBar');
    const batchProgressText = document.getElementById('batchProgressText');
    const batchProgressPct = document.getElementById('batchProgressPct');
    const batchJobList = document.getElementById('batchJobList');
    batchProgress.classList.remove('hidden');
    batchProgressText.textContent = 'Submitting batch...';
    batchProgressBar.style.width = '5%';
    batchProgressPct.textContent = '5%';

    const preset = document.getElementById('batchPreset').value;
    const language = document.getElementById('batchLanguage').value;

    const formData = new FormData();
    selectedFiles.forEach(f => formData.append('files', f));

    const params = new URLSearchParams({ preset });
    if (language) params.append('language', language);

    try {
        const res = await fetch(`/v1/batch/analyze?${params}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${API_KEY}` },
            body: formData,
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || `HTTP ${res.status}`);
        }

        const batch = await res.json();
        batchProgressText.textContent = `Batch submitted: ${batch.queued} queued, ${batch.rejected} rejected`;
        batchProgressBar.style.width = '10%';
        batchProgressPct.textContent = '10%';

        // Render initial job list
        renderJobList(batchJobList, batch.jobs);

        // Poll for completion
        const batchId = batch.batch_id;
        while (true) {
            await new Promise(r => setTimeout(r, 3000));

            const pollRes = await fetch(`/v1/batch/${batchId}`, {
                headers: { 'Authorization': `Bearer ${API_KEY}` },
            });
            const status = await pollRes.json();

            const total = status.total || 1;
            const complete = status.complete || 0;
            const failed = status.failed || 0;
            const done = complete + failed;
            const pct = Math.round((done / total) * 100);

            batchProgressBar.style.width = Math.max(10, pct) + '%';
            batchProgressPct.textContent = pct + '%';
            batchProgressText.textContent = `${complete} complete, ${failed} failed, ${status.processing || 0} processing, ${status.queued || 0} queued`;

            renderJobList(batchJobList, status.jobs);

            if (status.status === 'complete') {
                batchProgressText.textContent = `✓ Batch complete! ${complete} succeeded, ${failed} failed.`;
                batchProgressBar.style.width = '100%';
                batchProgressPct.textContent = '100%';
                break;
            }
        }

    } catch (err) {
        document.getElementById('batchErrorText').textContent = err.message;
        batchError.classList.remove('hidden');
    }

    document.getElementById('batchSubmitBtn').disabled = false;
    document.getElementById('batchSubmitBtn').classList.remove('opacity-50');
}

function renderJobList(container, jobs) {
    container.innerHTML = jobs.map(j => {
        const statusColors = {
            'queued': 'text-gray-400 bg-gray-800',
            'processing': 'text-yellow-400 bg-yellow-500/10',
            'complete': 'text-green-400 bg-green-500/10',
            'failed': 'text-red-400 bg-red-500/10',
            'rejected': 'text-red-400 bg-red-500/10',
        };
        const cls = statusColors[j.status] || 'text-gray-400 bg-gray-800';
        const link = j.speech_id ? `<a href="/recordings/${j.speech_id}" class="text-indigo-400 hover:text-indigo-300 text-xs ml-2">View →</a>` : '';
        const error = j.error ? `<span class="text-xs text-red-400 ml-2">${j.error.substring(0, 60)}</span>` : '';
        return `
            <div class="flex items-center justify-between ${cls} rounded-lg px-3 py-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm">${j.filename}</span>
                    ${error}${link}
                </div>
                <span class="text-xs font-mono uppercase">${j.status}</span>
            </div>
        `;
    }).join('');
}
</script>
{% endblock %}
