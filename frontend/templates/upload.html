{% extends "base.html" %}
{% block title %}Upload — SpeechScore{% endblock %}

{% block content %}
<div class="fade-in max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-white mb-2">Upload Audio</h1>
    <p class="text-sm text-gray-400 mb-8">Upload an audio file for full speech analysis. Supports MP3, WAV, OGG, FLAC, M4A, OPUS.</p>

    <!-- Upload Zone -->
    <div id="dropZone" class="border-2 border-dashed border-gray-700 rounded-xl p-12 text-center hover:border-indigo-500 transition-colors cursor-pointer"
         onclick="document.getElementById('fileInput').click()">
        <div id="dropContent">
            <svg class="mx-auto h-12 w-12 text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-gray-300 font-medium">Drop audio file here or click to browse</p>
            <p class="text-sm text-gray-500 mt-1">Max 50 MB</p>
        </div>
        <input type="file" id="fileInput" accept=".mp3,.wav,.ogg,.flac,.m4a,.opus,.webm" class="hidden">
    </div>

    <!-- Options -->
    <div class="mt-6 grid grid-cols-2 gap-4">
        <div>
            <label class="block text-sm text-gray-400 mb-1">Preset</label>
            <select id="preset" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white focus:border-indigo-500 focus:outline-none">
                <option value="full">Full Analysis</option>
                <option value="quick">Quick</option>
                <option value="clinical">Clinical</option>
                <option value="coaching">Coaching</option>
                <option value="text_only">Text Only</option>
                <option value="audio_only">Audio Only</option>
            </select>
        </div>
        <div>
            <label class="block text-sm text-gray-400 mb-1">Language</label>
            <select id="language" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white focus:border-indigo-500 focus:outline-none">
                <option value="en">English</option>
                <option value="">Auto-detect</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
            </select>
        </div>
    </div>

    <!-- Progress -->
    <div id="progress" class="hidden mt-6">
        <div class="flex items-center justify-between mb-2">
            <span id="progressText" class="text-sm text-gray-300">Uploading...</span>
            <span id="progressPct" class="text-sm text-gray-400 font-mono">0%</span>
        </div>
        <div class="w-full bg-gray-800 rounded-full h-2">
            <div id="progressBar" class="h-2 rounded-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- Result -->
    <div id="result" class="hidden mt-6"></div>

    <!-- Error -->
    <div id="error" class="hidden mt-6 bg-red-500/10 border border-red-500/30 rounded-xl p-4">
        <p id="errorText" class="text-sm text-red-300"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_KEY = 'sk-5b7fd66025ead6b8731ef73b2c970f26';
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const progressPct = document.getElementById('progressPct');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');

// Drag and drop
['dragenter', 'dragover'].forEach(e => {
    dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-500/5'); });
});
['dragleave', 'drop'].forEach(e => {
    dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('border-indigo-500', 'bg-indigo-500/5'); });
});
dropZone.addEventListener('drop', ev => { if (ev.dataTransfer.files.length) uploadFile(ev.dataTransfer.files[0]); });
fileInput.addEventListener('change', () => { if (fileInput.files.length) uploadFile(fileInput.files[0]); });

async function uploadFile(file) {
    // Reset UI
    errorDiv.classList.add('hidden');
    resultDiv.classList.add('hidden');
    progress.classList.remove('hidden');
    progressText.textContent = `Uploading ${file.name}...`;
    progressBar.style.width = '0%';
    progressPct.textContent = '0%';

    const preset = document.getElementById('preset').value;
    const language = document.getElementById('language').value;

    const formData = new FormData();
    formData.append('audio', file);

    // Use async mode
    const params = new URLSearchParams({ mode: 'async', preset });
    if (language) params.append('language', language);

    try {
        // Submit job
        progressBar.style.width = '10%';
        progressPct.textContent = '10%';
        const submitRes = await fetch(`/v1/analyze?${params}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${API_KEY}` },
            body: formData,
        });

        if (!submitRes.ok) {
            const err = await submitRes.json();
            throw new Error(err.error?.message || `HTTP ${submitRes.status}`);
        }

        const job = await submitRes.json();
        progressText.textContent = 'Analyzing...';
        progressBar.style.width = '20%';
        progressPct.textContent = '20%';

        // Poll for completion
        let result = null;
        const stages = ['transcription', 'text_analysis', 'audio_analysis', 'advanced_audio', 'sentiment', 'rhetorical'];
        while (true) {
            await new Promise(r => setTimeout(r, 1500));
            const pollRes = await fetch(`/v1/jobs/${job.job_id}`, {
                headers: { 'Authorization': `Bearer ${API_KEY}` },
            });
            const status = await pollRes.json();

            if (status.status === 'complete') {
                result = status.result;
                progressBar.style.width = '100%';
                progressPct.textContent = '100%';
                progressText.textContent = 'Complete!';
                break;
            } else if (status.status === 'failed') {
                throw new Error(status.error || 'Analysis failed');
            } else {
                // Update progress based on stage
                const stage = (status.progress || '').replace('processing:', '');
                const idx = stages.indexOf(stage);
                const pct = Math.min(90, 20 + (idx >= 0 ? (idx + 1) * 12 : 5));
                progressBar.style.width = pct + '%';
                progressPct.textContent = pct + '%';
                progressText.textContent = `Analyzing: ${stage || 'processing'}...`;
            }
        }

        // Show result
        const speechId = result.speech_id;
        resultDiv.innerHTML = `
            <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-green-300 mb-3">✓ Analysis Complete</h3>
                <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                    <div><span class="text-gray-400">WPM:</span> <span class="text-white font-mono">${result.audio_analysis?.speaking_rate?.overall_wpm?.toFixed(0) || '—'}</span></div>
                    <div><span class="text-gray-400">Pitch:</span> <span class="text-white font-mono">${result.audio_analysis?.pitch?.mean_hz?.toFixed(0) || '—'} Hz</span></div>
                    <div><span class="text-gray-400">Quality:</span> <span class="text-white font-mono">${result.audio_quality?.confidence || '—'}</span></div>
                </div>
                ${speechId ? `<a href="/speeches/${speechId}" class="inline-block px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium rounded-lg transition-colors">View Full Analysis →</a>` : ''}
            </div>
        `;
        resultDiv.classList.remove('hidden');

    } catch (err) {
        document.getElementById('errorText').textContent = err.message;
        errorDiv.classList.remove('hidden');
        progress.classList.add('hidden');
    }
}
</script>
{% endblock %}
