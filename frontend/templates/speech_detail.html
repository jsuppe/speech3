{% extends "base.html" %}
{% block title %}{{ speech.title }} ‚Äî SpeakFit{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Back + Title -->
    <div class="mb-6">
        <a href="/speeches" class="text-sm text-gray-400 hover:text-white transition-colors">‚Üê Back to library</a>
        
        <!-- Editable Title -->
        <div class="flex items-center gap-2 mt-2 group">
            <h1 id="titleDisplay" class="text-2xl font-bold text-white cursor-pointer hover:text-indigo-300 transition-colors" 
                onclick="startEditTitle()" title="Click to edit">{{ speech.title }}</h1>
            <input type="text" id="titleInput" 
                   class="hidden text-2xl font-bold text-white bg-gray-800 border border-indigo-500 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   value="{{ speech.title }}"
                   onkeydown="handleTitleKey(event)"
                   onblur="cancelEditTitle()">
            <button onclick="startEditTitle()" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-indigo-400 transition-all" title="Edit title">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
            </button>
            <span id="titleSaving" class="hidden text-xs text-indigo-400">Saving...</span>
            <span id="titleSaved" class="hidden text-xs text-green-400">‚úì Saved</span>
        </div>
        
        <!-- Editable Speaker + Other Info -->
        <div class="flex items-center gap-4 mt-1 text-sm text-gray-400">
            <div class="flex items-center gap-1 group">
                <span id="speakerDisplay" class="cursor-pointer hover:text-indigo-300 transition-colors" 
                      onclick="startEditSpeaker()" title="Click to edit">{{ speech.speaker or 'Unknown Speaker' }}</span>
                <input type="text" id="speakerInput"
                       class="hidden text-sm text-white bg-gray-800 border border-indigo-500 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       value="{{ speech.speaker or '' }}"
                       placeholder="Speaker name"
                       onkeydown="handleSpeakerKey(event)"
                       onblur="cancelEditSpeaker()">
                <button onclick="startEditSpeaker()" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-indigo-400 transition-all" title="Edit speaker">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                    </svg>
                </button>
                <span id="speakerSaving" class="hidden text-xs text-indigo-400">Saving...</span>
                <span id="speakerSaved" class="hidden text-xs text-green-400">‚úì</span>
            </div>
            {% if speech.year %}<span>{{ speech.year }}</span>{% endif %}
            {% if speech.duration_sec %}<span>{{ "%.1f"|format(speech.duration_sec) }}s</span>{% endif %}
            {% if speech.category %}<span>{{ speech.category }}</span>{% endif %}
        </div>
        <div class="flex gap-1.5 mt-2">
            {% for p in speech.products %}
            <span class="px-2 py-0.5 text-xs rounded-full
                {% if p == 'SpeakFit' %}bg-indigo-500/20 text-indigo-300
                {% elif p == 'OratoScore' %}bg-amber-500/20 text-amber-300
                {% elif p == 'PitchPerfect' %}bg-green-500/20 text-green-300
                {% elif p == 'ReadAloud' %}bg-cyan-500/20 text-cyan-300
                {% else %}bg-rose-500/20 text-rose-300{% endif %}">{{ p }}</span>
            {% endfor %}
        </div>
    </div>

    {% if score %}
    <!-- Overall Score Card -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white">SpeakFit Score</h2>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-400">Profile:</label>
                <select id="profileSelect" onchange="window.location.href='/speeches/{{ speech.id }}?profile=' + this.value"
                    class="px-2 py-1 bg-gray-800 border border-gray-700 rounded text-sm text-white focus:border-indigo-500 focus:outline-none">
                    {% for p in available_profiles %}
                    <option value="{{ p }}" {% if p == current_profile %}selected{% endif %}>{{ p|title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Big Grade Display -->
            <div class="flex flex-col items-center justify-center p-4">
                <div class="text-6xl font-black" style="color: {{ score.grade_color }}">{{ score.letter_grade }}</div>
                <div class="text-2xl font-bold text-white mt-1">{{ score.composite_score }}</div>
                <div class="text-xs text-gray-500 mt-1">{{ score.profile_description }}</div>
            </div>

            <!-- Category Scores -->
            <div class="col-span-3 grid grid-cols-2 sm:grid-cols-4 gap-3">
                {% for cat_key, cat in score.category_scores.items() %}
                <div class="bg-gray-800/50 rounded-lg p-3 text-center">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">{{ cat.label }}</div>
                    <div class="text-2xl font-bold mt-1" style="color: {{ cat.grade_color }}">{{ cat.grade }}</div>
                    <div class="text-sm text-gray-400">{{ cat.score }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if score.strengths or score.improvements %}
        <div class="grid md:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-800">
            {% if score.strengths %}
            <div>
                <h3 class="text-sm font-medium text-green-400 mb-2">üí™ Strengths</h3>
                {% for s in score.strengths %}
                <div class="text-sm text-gray-300">‚Ä¢ {{ s }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% if score.improvements %}
            <div>
                <h3 class="text-sm font-medium text-amber-400 mb-2">üìà Areas for Improvement</h3>
                {% for i in score.improvements %}
                <div class="text-sm text-gray-300">‚Ä¢ {{ i }}</div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Metric Score Breakdown -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white">Metric Breakdown</h2>
            <span class="text-xs text-gray-500">Hover <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-indigo-500/25 text-indigo-400 text-[9px] font-semibold">?</span> for explanations</span>
        </div>
        <div class="space-y-3">
            {% for metric_name, m in score.metric_scores.items() %}
            {% if m.available and m.score is not none %}
            <div class="flex items-center gap-3">
                <div class="w-36 text-sm text-gray-400">
                    <span class="metric-tip tip-left">
                        <span class="truncate">{{ m.label }}</span><span class="tip-icon">?</span>
                        {% if metric_info.get(metric_name) %}<span class="tip-text">{{ metric_info[metric_name] }}</span>
                        {% elif metric_info.get(m.label) %}<span class="tip-text">{{ metric_info[m.label] }}</span>{% endif %}
                    </span>
                </div>
                <div class="flex-1">
                    <div class="w-full bg-gray-800 rounded-full h-3 relative">
                        <div class="h-3 rounded-full transition-all duration-500"
                             style="width: {{ m.score }}%; background-color: {{ m.grade_color }};"></div>
                    </div>
                </div>
                <div class="w-10 text-right text-sm font-mono font-bold" style="color: {{ m.grade_color }}">{{ m.grade }}</div>
                <div class="w-12 text-right text-sm text-gray-400 font-mono">{{ m.score }}</div>
                <div class="w-24 text-right text-xs text-gray-500">
                    {{ m.value }}{% if m.unit %} {{ m.unit }}{% endif %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Score Radar + Bar Charts -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Score Profile</h2>
            <canvas id="scoreRadarChart" height="280"></canvas>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Metric Scores</h2>
            <canvas id="scoreBarChart" height="280"></canvas>
        </div>
    </div>
    {% endif %}

    {% if analysis %}
    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
        {% set metrics = [
            ("WPM", analysis.wpm, "%.0f", "words/min"),
            ("Pitch", analysis.pitch_mean_hz, "%.0f", "Hz mean"),
            ("Jitter", analysis.jitter_pct, "%.2f", "%"),
            ("Shimmer", analysis.shimmer_pct, "%.1f", "%"),
            ("HNR", analysis.hnr_db, "%.1f", "dB"),
            ("Vocal Fry", analysis.vocal_fry_ratio, "%.1f%%", "ratio"),
            ("Lex Diversity", analysis.lexical_diversity, "%.3f", ""),
            ("Complexity", analysis.syntactic_complexity, "%.1f", "depth"),
            ("Grade Level", analysis.fk_grade_level, "%.1f", "FK"),
            ("Repetition", analysis.repetition_score, "%.2f", "score"),
            ("Sentiment", analysis.sentiment, "%s", ""),
            ("Quality", analysis.quality_level, "%s", ""),
        ] %}
        {% for label, value, fmt, unit in metrics %}
        {% if value is not none %}
        <div class="metric-card bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">
                <span class="metric-tip{% if loop.index <= 2 %} tip-left{% elif loop.index > 10 %} tip-right{% endif %}">
                    {{ label }}<span class="tip-icon">?</span>
                    {% if metric_info.get(label) %}<span class="tip-text">{{ metric_info[label] }}</span>{% endif %}
                </span>
            </div>
            <div class="text-xl font-bold text-white mt-1">
                {% if value is number %}
                {{ fmt|format(value if 'fry' not in label.lower() else value * 100) }}
                {% else %}
                {{ value }}
                {% endif %}
            </div>
            {% if unit %}<div class="text-xs text-gray-500">{{ unit }}</div>{% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Spectrogram -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Analysis Profile</h2>
            <canvas id="radarChart" height="250"></canvas>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Spectrogram</h2>
            {% if has_spectrogram %}
            <img src="/speeches/{{ speech.id }}/spectrogram.png"
                 alt="Spectrogram" class="w-full rounded-lg" loading="lazy">
            {% else %}
            <div class="flex items-center justify-center h-48 text-gray-500">No spectrogram available</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Audio Player + Transcript -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
        {% if has_audio %}
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Audio</h2>
            <audio controls class="w-full" preload="none">
                <source src="/speeches/{{ speech.id }}/audio.opus" type="audio/opus">
                Your browser does not support the audio element.
            </audio>
            <div class="text-xs text-gray-500 mt-2">
                Opus ‚Ä¢ {{ "%.1f"|format(audio_size / 1024) }} KB
            </div>
        </div>
        {% endif %}

        {% if transcription %}
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Transcript</h2>
            <div class="text-sm text-gray-300 leading-relaxed max-h-64 overflow-y-auto pr-2">
                {{ transcription.text }}
            </div>
            <div class="text-xs text-gray-500 mt-3 pt-3 border-t border-gray-800">
                {{ transcription.word_count }} words ‚Ä¢ {{ transcription.language or 'en' }}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Full JSON (collapsible) -->
    <details class="bg-gray-900 border border-gray-800 rounded-xl mb-6">
        <summary class="p-4 cursor-pointer text-sm font-medium text-gray-400 hover:text-white transition-colors">
            Full Analysis JSON
        </summary>
        <pre class="p-4 pt-0 text-xs text-gray-400 overflow-x-auto max-h-96 overflow-y-auto"><code>{{ full_result }}</code></pre>
    </details>

    <!-- Actions -->
    <div class="flex gap-3">
        <a href="/speeches/{{ speech.id }}/audio.opus" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-sm text-white rounded-lg transition-colors" download>
            Download Audio
        </a>
        <a href="/compare?ids={{ speech.id }}" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-sm text-white rounded-lg transition-colors">
            Compare
        </a>
        <a href="/v1/speeches/{{ speech.id }}/benchmark" target="_blank" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-sm text-white rounded-lg transition-colors">
            Benchmark JSON
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inline editing functions
const speechId = {{ speech.id }};

function startEditTitle() {
    document.getElementById('titleDisplay').classList.add('hidden');
    const input = document.getElementById('titleInput');
    input.classList.remove('hidden');
    input.focus();
    input.select();
}

function cancelEditTitle() {
    setTimeout(() => {
        document.getElementById('titleInput').classList.add('hidden');
        document.getElementById('titleDisplay').classList.remove('hidden');
    }, 150);
}

function handleTitleKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        saveTitle();
    } else if (event.key === 'Escape') {
        document.getElementById('titleInput').value = document.getElementById('titleDisplay').textContent;
        cancelEditTitle();
    }
}

async function saveTitle() {
    const input = document.getElementById('titleInput');
    const display = document.getElementById('titleDisplay');
    const saving = document.getElementById('titleSaving');
    const saved = document.getElementById('titleSaved');
    const newTitle = input.value.trim();
    
    if (!newTitle) return;
    
    input.classList.add('hidden');
    display.classList.remove('hidden');
    saving.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/speeches/${speechId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        });
        
        if (response.ok) {
            display.textContent = newTitle;
            saving.classList.add('hidden');
            saved.classList.remove('hidden');
            setTimeout(() => saved.classList.add('hidden'), 2000);
        } else {
            const err = await response.json();
            alert('Failed to save: ' + (err.error?.message || 'Unknown error'));
            saving.classList.add('hidden');
        }
    } catch (e) {
        alert('Failed to save: ' + e.message);
        saving.classList.add('hidden');
    }
}

function startEditSpeaker() {
    document.getElementById('speakerDisplay').classList.add('hidden');
    const input = document.getElementById('speakerInput');
    input.classList.remove('hidden');
    input.focus();
    input.select();
}

function cancelEditSpeaker() {
    setTimeout(() => {
        document.getElementById('speakerInput').classList.add('hidden');
        document.getElementById('speakerDisplay').classList.remove('hidden');
    }, 150);
}

function handleSpeakerKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        saveSpeaker();
    } else if (event.key === 'Escape') {
        document.getElementById('speakerInput').value = document.getElementById('speakerDisplay').textContent;
        cancelEditSpeaker();
    }
}

async function saveSpeaker() {
    const input = document.getElementById('speakerInput');
    const display = document.getElementById('speakerDisplay');
    const saving = document.getElementById('speakerSaving');
    const saved = document.getElementById('speakerSaved');
    const newSpeaker = input.value.trim() || 'Unknown Speaker';
    
    input.classList.add('hidden');
    display.classList.remove('hidden');
    saving.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/speeches/${speechId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ speaker: newSpeaker })
        });
        
        if (response.ok) {
            display.textContent = newSpeaker;
            saving.classList.add('hidden');
            saved.classList.remove('hidden');
            setTimeout(() => saved.classList.add('hidden'), 2000);
        } else {
            const err = await response.json();
            alert('Failed to save: ' + (err.error?.message || 'Unknown error'));
            saving.classList.add('hidden');
        }
    } catch (e) {
        alert('Failed to save: ' + e.message);
        saving.classList.add('hidden');
    }
}

{% if score %}
// Score data from backend
const scoreData = {{ score_json|safe }};

// Score Radar Chart
if (scoreData && scoreData.metric_scores) {
    const metricEntries = Object.entries(scoreData.metric_scores)
        .filter(([k, v]) => v.available && v.score !== null);

    const radarLabels = metricEntries.map(([k, v]) => v.label);
    const radarValues = metricEntries.map(([k, v]) => v.score);
    const radarColors = metricEntries.map(([k, v]) => v.grade_color);

    new Chart(document.getElementById('scoreRadarChart'), {
        type: 'radar',
        data: {
            labels: radarLabels,
            datasets: [{
                data: radarValues,
                backgroundColor: 'rgba(99, 102, 241, 0.15)',
                borderColor: '#6366f1',
                borderWidth: 2,
                pointBackgroundColor: radarColors,
                pointBorderColor: radarColors,
                pointRadius: 5,
                pointHoverRadius: 7,
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const idx = ctx.dataIndex;
                            const m = metricEntries[idx][1];
                            return `${m.label}: ${m.score} (${m.grade}) ‚Äî ${m.value} ${m.unit}`;
                        }
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: '#1f2937' },
                    angleLines: { color: '#1f2937' },
                    ticks: { display: false },
                    pointLabels: { color: '#9ca3af', font: { size: 10 } },
                }
            }
        }
    });

    // Score Bar Chart
    new Chart(document.getElementById('scoreBarChart'), {
        type: 'bar',
        data: {
            labels: radarLabels,
            datasets: [{
                data: radarValues,
                backgroundColor: radarColors.map(c => c + '99'),
                borderColor: radarColors,
                borderWidth: 1,
                borderRadius: 4,
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const idx = ctx.dataIndex;
                            const m = metricEntries[idx][1];
                            return `Score: ${m.score} (${m.grade})`;
                        }
                    }
                }
            },
            scales: {
                x: { beginAtZero: true, max: 100, grid: { color: '#1f2937' }, ticks: { color: '#9ca3af' } },
                y: { grid: { display: false }, ticks: { color: '#9ca3af', font: { size: 10 } } },
            }
        }
    });
}
{% endif %}

{% if analysis %}
// Legacy radar chart
const metrics = {
    'WPM': {{ analysis.wpm or 0 }},
    'Pitch Var': {{ analysis.pitch_std_hz or 0 }},
    'Voice Quality': {{ analysis.hnr_db or 0 }},
    'Lex Diversity': {{ (analysis.lexical_diversity or 0) * 100 }},
    'Complexity': {{ analysis.syntactic_complexity or 0 }},
    'Repetition': {{ (analysis.repetition_score or 0) * 10 }},
};

const norms = {
    'WPM': [80, 200],
    'Pitch Var': [0, 100],
    'Voice Quality': [0, 25],
    'Lex Diversity': [0, 80],
    'Complexity': [5, 30],
    'Repetition': [0, 60],
};

const labels = Object.keys(metrics);
const values = labels.map(l => {
    const [min, max] = norms[l];
    return Math.min(100, Math.max(0, ((metrics[l] - min) / (max - min)) * 100));
});

new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: 'rgba(99, 102, 241, 0.2)',
            borderColor: '#6366f1',
            borderWidth: 2,
            pointBackgroundColor: '#6366f1',
            pointRadius: 4,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            r: {
                beginAtZero: true,
                max: 100,
                grid: { color: '#1f2937' },
                angleLines: { color: '#1f2937' },
                ticks: { display: false },
                pointLabels: { color: '#9ca3af', font: { size: 11 } },
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
